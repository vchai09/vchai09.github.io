---
output: 
    html_document:
    df_print: kable
editor_options: 
  chunk_output_type: console
---
[//]: # CSS style arguments

<style type="text/css">

@import url("https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700,700i&display=swap");

h1, h2, h3, h4, h5, body, ul, ol, p {
font-family: 'Open Sans', sans-serif;

}

body{ /* Normal  */
font-size: 20px;
counter-reset:table figure;
}

.table{
width:auto;
font-size:12px;
}

td, th{
padding-left:10px;
text-align: right;
}

caption::before{
counter-increment: table;
content: "Table " counter(table) ": ";
}

.caption::before{
counter-increment: figure;
content: "Figure " counter(figure) ": ";
}

caption, .caption{
font-style:italic;
font-size: 16px;
margin-top:0.5em;
margin-bottom:0.5em;
width:80%;
text-align: left;
}

#TOC {
font-size: 17px;
width: 100%;
}

</style>

```{r setup, include=FALSE}

# You can set a default figure size here so you don't have to customize every time
knitr::opts_chunk$set(fig.width=12, fig.height=10, warning=FALSE, message=FALSE, cache=FALSE, echo=FALSE)

```

```{r}

# '# PROLOG   ##################################################################'
# '#                                                                           #'
# '# PROJECT: EHDI                                                             #'
# '# PURPOSE: To create visualizations for earlyhearinglossdata website        #'
# '# DIR:     Box\CPHSS\EHDI Seeser\Data\Scripts                               #'
# '# RPRJ:    Box\CPHSS\EHDI Seeser\Data\Data.Rproj                            #'
# '# DATA:    Box\CPHSS\EHDI Seeser\Data\website_ready_data                    #'
# '# AUTHOR:  Veronica L Chaitan                                               #'
# '# CREATED: Aug 09, 2023                                                     #'
# '# LATEST:  SEP 26, 2023                                                     #'
# '# NOTES:                                                                    #'
# '#                                                                           #'
# '# PROLOG   ##################################################################'

# v5 update to incorporate box plots, heat maps, etc
# It will be challenging to incorporate a crosstalk shareddata that uses filter and uses highlighting, so instead we will create individual tabs to tell a story for each variable. We will include a tab for each, a descriptive piece, and then all the figures that will allow a state to conduct a comparison. 


library(readxl)
library(htmltools)
library(crosstalk)
library(plotly)
library(kableExtra)
library(magrittr)
library(tidyverse)

# for NA in kable
options(knitr.kable.NA = "")

# Theme settings
# theme_set(theme_minimal()) - doesn't carry over across chunks in RMD
# In general
mytheme <- theme_minimal() + 
  theme(text = element_text(size=11, color="gray23"),
        panel.grid = element_blank(),
        axis.text.x = element_text(size=8, color="gray23"),
        axis.text.y = element_text(size=10, color="gray23"),
        axis.title = element_blank(),
        plot.title = element_blank(),
        legend.position = "top",
        legend.title = element_blank())

## A function that we need for rounding even based .5 numbers
# https://appsilon.com/rounding-issues-in-r-julia-and-python/
true_round <- function(number, digits) {
  posneg <- sign(number)
  number <- abs(number) * 10^digits
  number <- number + 0.5 + sqrt(.Machine$double.eps)
  number <- trunc(number)
  number <- number / 10 ^ digits
  number * posneg
}


# Read in the latest dataset
r <- read_csv("../website_ready_data/ehdidata_2007to2020_cleaned20230926.csv")

# Descriptive table information
vardesc <- read_xlsx("../website_ready_data/variableDescriptionsForWebsite_v3.xlsx")

# Read in the states to get states abbr
states <- read_csv("../website_ready_data/states.csv")

# State codes
r <- r %>%
  # Joining with `by = join_by(State)`
  left_join(states)

# Long format for mapping
r1 <- r %>% 
  pivot_longer(
    # identify the columns you want as identifiers
    -c(State,Year,Abbrev,Code)) %>%
  left_join(states) %>%
  # Order the states
  mutate(State = factor(State,
                        levels=c(sort(unique(states$State)),
                                 "US","State average","State median"))) %>%
  # Account for the missing abbreviation
  mutate(Code = case_when(State %in% c("US","State average","State median") ~ State,
                          TRUE ~ Code))


# Add in the descriptive...
r1 <- r1 %>%
  left_join(vardesc, by = c("name" = "Variable Abbreviation")) %>%
  # Order it
  mutate(Variable = factor(Variable,
                           # We are manually ordering in this what we want it to be 
                           levels=vardesc$Variable)) %>%
  arrange(Variable)


# Get these??

### State Mean
### State Median
# US

### Now prepare the ordering for the data that will be used later ----

## RANKING ----
r1 <- 
  # Split then add it back
  bind_rows(
    
    r1 %>%
      # We will apply this to just individual states
      filter(!State %in% c("State average","State median")) %>%
      # US is shown in ranking in initial version of website
      # Order by the value descing
      arrange(Variable,Year,desc(value)) %>%
      # For each year, each variable, by state
      group_by(Variable,Year) %>%
      # Manually identify the rank from 1:51 364 combos of year/variable
      mutate(Rank1 = rep(1:(length(unique(r$State)) -
                              length(c("State average","State median")))), 
             Rank2 = rank(-value,
                          na.last="keep",  # put NA values as NA
                          ties.method="first"),
             Rank1Plot = 52 - Rank1,  # Plots from top to bottom
             Rank2Plot = 52 - Rank2)  %>%  # permutate through ties
      # Remove grouping
      ungroup()
    
    ,
    
    # Add back in the other data
    r1 %>% 
      filter(State %in% c("State average","State median"))  # Negate what was used above
    
  )  # close bind rows


## Annual State Quartiles ----
r1 <- 
  # Split then add it back
  bind_rows(
    
    r1 %>%
      # We will apply this to just individual states
      filter(!State %in% c("US","State average","State median")) %>%
      # For each year, each variable
      group_by(Variable,Year) %>%
      # Manually identify the rank from 1:51 364 combos of year/variable
      mutate(Quartile = factor(ntile(value, 4),  # Assign to group, ignore NA
                               levels=1:4,  # identify that values are 1:4
                               labels = c("Lowest","Mod Low",  # Labels
                                          "Mod High","Highest"))) %>%
      # Remove grouping
      ungroup()
    
    ,
    
    # Add back in the other data
    r1 %>% 
      filter(State %in% c("US","State average","State median")) %>%  # Negate what was used above
      mutate(Quartile = "--")  # Add this in now
    
  )  # close bind rows


## Identify the 2020 median values ----
r1 <- r1 %>%
  
  # Add the median as an identifier
  left_join(  # Joining with `by = join_by(Variable)`
    r1 %>%
      # Filter to the value of interest
      filter(State == "State median" & Year == 2020) %>%
      # Rename the value to median for identification
      rename(median2020 = value) %>%
      # Limit the variables for rejoining
      select(Variable,median2020) %>%
      distinct()
    
    # # FOR TESTING AND BUILDING CODE
    # mutate(median2020 =  1.82) %>%  # Manually checked for HLp to TEST CODE
    # # Limit the variables for rejoining
    # select(Variable,median2020)
    
  ) # Close left_join

# Identify where the value is less than the median or not
# MIGHT ADD THESE FOR THE SECTION ITSELF AFTER ROUNDING OCCURS
r1 <- 
  # Split then add it back
  bind_rows(
    
    r1 %>%
      # We will apply this to just individual states
      filter(!State %in% c("US","State average","State median")) %>%
      mutate(medianCat = factor(
        ifelse(value < median2020,
               "Below","Above"
               # paste0("Below 2019 median ",name," (",median2020,")"),
               #  paste0("Above 2019 median ",name," (",median2020,")")
        ))) %>%
      # Might need to add levels
      
      # Add a count
      group_by(Year,Variable,medianCat) %>%
      mutate(medianCatCount = n()) %>%
      # And annual percent
      group_by(Year,Variable) %>%
      mutate(
        denom = sum(!is.na(value)),  # states with data
        pc = true_round(medianCatCount/denom * 100, 1)) %>%
      # Update the number for plotting
      mutate(medianCatCountPlot = 
               ifelse(medianCat=="Below", medianCatCount*-1, medianCatCount)) %>%
      ungroup()
    
    ,
    
    # Add back in the other data
    r1 %>% 
      filter(State %in% c("US","State average","State median"))  # Negate what was used above
    
  )  # close bind rows


## Now identify how values fall into the latest year's quartile ----

r1 <- r1 %>%
  
  # Calculate the quartiles to bring in
  left_join(  # Joining with `by = join_by(Year, Variable)`
    r1 %>%
      # We will apply this to just individual states
      filter(!State %in% c("US","State average","State median")) %>%
      # Just the latest year  
      filter(Year==2020) %>%
      # And for each year/variable
      group_by(Variable) %>%
      # Get the quartile values
      summarise(q0_20 = quantile(value,c(0), na.rm=T),
                q1_20 = quantile(value,c(0.25), na.rm=T),
                q2_20 = quantile(value,c(0.5), na.rm=T),
                q3_20 = quantile(value,c(0.75), na.rm=T),
                q4_20 = quantile(value,c(1), na.rm=T)) %>%
      ungroup() %>%
      distinct()
  ) %>% # close left join
  
  # Identify the quartile
  mutate(Quartile2020 = case_when(value < q1_20 ~ "1st",
                                  value >= q1_20 & value < q2_20 ~ "2nd",
                                  value >= q2_20 & value < q3_20 ~ "3rd",
                                  value >= q3_20 ~ "4th"))


```



<!-- We want tabs so we first need to have text as a heading, add the tabset feature here. Then anything else added as a heading under it will be under the tab! Arguments are .tabset-pills and .tabset-fade --> 

<!-- Things we need to decide 
1) Loss to follow up - we have this as a calculation but only a single variable is available for the earlier years. So perhaps we need to just use this for our calculations. It is unclear if this is the case for every year or not-->

# {.tabset}

Use this page to explore 2007-2020 EHDI data. Shown below are percentages and rates calculated from EHDI data reported to CDC> 

Figures are interactive allowing you to hover for more information, zoom in/out, or download a plot as PNG (among the tools in upper right of each plot).

"US" data are totals across all states and territories in a year. 

"State average" and "State median" are calculated from available data for the 50 states and District of Columbia in year. 

Page may take a few moments to load. 

<br>

<em>Select a tab to explore a metric:</em>

<br>

## <strong>Hearing loss prevalence</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name == "HLp")

# Rounding specific to the variable
varround <- 3

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)])) %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```




<!-- ## <strong>`r unique(vardesc$Variable)[3]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[3]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[3] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)])) %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->




<!-- ## <strong>`r unique(vardesc$Variable)[4]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[4]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[4] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[5]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[5]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[5] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[6]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[6]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[6] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[7]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[7]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[7] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[8]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[8]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[8] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->








<!-- ## <strong>`r unique(vardesc$Variable)[9]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[9]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[9] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[10]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[10]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[10] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[11]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[11]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[11] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))  -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[12]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[12]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[12] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[13]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[13]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[13] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->




<!-- ## <strong>`r unique(vardesc$Variable)[14]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[14]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[14] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[15]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[15]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[15] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[16]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[16]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[16] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[17]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[17]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[17] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[18]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[18]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[18] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->








<!-- ## <strong>`r unique(vardesc$Variable)[19]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[19]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[19] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->





<!-- ## <strong>`r unique(vardesc$Variable)[20]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[20]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[20] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[21]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[21]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[21] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[22]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[22]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[22] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[23]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[23]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[23] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->




<!-- ## <strong>`r unique(vardesc$Variable)[24]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[24]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[24] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[25]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[25]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[25] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[26]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[26]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[26] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[27]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[27]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[27] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






## <strong>`r unique(vardesc$Variable)[28]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[28])

# Rounding specific to the variable
varround <- vardesc$Rounding[28]

```

<br>  

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.  

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```








## <strong>`r unique(vardesc$Variable)[29]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[29])

# Rounding specific to the variable
varround <- vardesc$Rounding[29]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```





## <strong>`r unique(vardesc$Variable)[30]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[30])

# Rounding specific to the variable
varround <- vardesc$Rounding[30]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```






## <strong>`r unique(vardesc$Variable)[31]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[31])

# Rounding specific to the variable
varround <- vardesc$Rounding[31]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```






## <strong>`r unique(vardesc$Variable)[32]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[32])

# Rounding specific to the variable
varround <- vardesc$Rounding[32]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```







```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[33])

# Rounding specific to the variable
varround <- vardesc$Rounding[33]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>



<!-- ## <strong>`r unique(vardesc$Variable)[33]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[33]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[33] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))  -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->




<!-- ## <strong>`r unique(vardesc$Variable)[34]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[34]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[34] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->




## <strong>`r unique(vardesc$Variable)[35]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[35])

# Rounding specific to the variable
varround <- vardesc$Rounding[35]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```







```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[36])

# Rounding specific to the variable
varround <- vardesc$Rounding[36]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>



<!-- ## <strong>`r unique(vardesc$Variable)[36]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[36]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[36] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






## <strong>`r unique(vardesc$Variable)[37]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[37])

# Rounding specific to the variable
varround <- vardesc$Rounding[37]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```






## <strong>`r unique(vardesc$Variable)[38]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[38])

# Rounding specific to the variable
varround <- vardesc$Rounding[38]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)])) %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```








## <strong>`r unique(vardesc$Variable)[39]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[39])

# Rounding specific to the variable
varround <- vardesc$Rounding[39]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```


## <strong>`r unique(vardesc$Variable)[40]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[40])

# Rounding specific to the variable
varround <- vardesc$Rounding[40]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```






## <strong>`r unique(vardesc$Variable)[41]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[41])

# Rounding specific to the variable
varround <- vardesc$Rounding[41]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```






## <strong>`r unique(vardesc$Variable)[42]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[42])

# Rounding specific to the variable
varround <- vardesc$Rounding[42]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```


## <strong>`r unique(vardesc$Variable)[43]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[43])

# Rounding specific to the variable
varround <- vardesc$Rounding[43]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```



## <strong>`r unique(vardesc$Variable)[44]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[44])

# Rounding specific to the variable
varround <- vardesc$Rounding[44]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```

## <strong>`r unique(vardesc$Variable)[45]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[45])

# Rounding specific to the variable
varround <- vardesc$Rounding[45]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```


## <strong>`r unique(vardesc$Variable)[46]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[46])

# Rounding specific to the variable
varround <- vardesc$Rounding[46]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```






<!-- ## <strong>`r unique(vardesc$Variable)[47]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[47]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[47] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






## <strong>`r unique(vardesc$Variable)[48]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[48])

# Rounding specific to the variable
varround <- vardesc$Rounding[48]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```








<!-- ## <strong>`r unique(vardesc$Variable)[49]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[49]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[49] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->










<!-- ## <strong>`r unique(vardesc$Variable)[50]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[50]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[50] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[51]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[51]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[51] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->






<!-- ## <strong>`r unique(vardesc$Variable)[52]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[52]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[52] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))  -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->


<!-- ## <strong>`r unique(vardesc$Variable)[53]`</strong> -->

<!-- ```{r} -->

<!-- # Set this up at the start of the chunks for a variable! -->

<!-- # Dataframe to be used -->
<!-- r_var <- r1 %>% -->
<!--   # Filter to the variable of interest for use -->
<!--   filter(name %in% vardesc$`Variable Abbreviation`[53]) -->

<!-- # Rounding specific to the variable -->
<!-- varround <- vardesc$Rounding[53] -->

<!-- ``` -->

<!-- <br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br> -->

<!-- ### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em> -->

<!-- Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year. -->

<!-- ```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")} -->

<!-- # Then utilize as needed with formatting -->
<!-- r_var1 <- r_var %>% -->
<!--   # Edit for display -->
<!--   mutate(medianCat = factor( -->
<!--     ifelse(medianCat == "Below",  -->
<!--            paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"), -->
<!--            paste0("Above 2020 median ",name," (",true_round(median2020,varround),")") -->
<!--     ))) %>% -->
<!--   select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>% -->
<!--   distinct() %>% -->
<!--   na.omit() -->


<!-- plot1 <- r_var1 %>%  -->
<!--   ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat, -->
<!--              text = paste0(Year,"\nStates: ",`medianCatCount`, -->
<!--                            " (",pc,"%)"))) + -->
<!--   geom_col() +  -->
<!--   geom_hline(yintercept=0,  color = 'white') +  -->
<!--   geom_text(aes(label =label,x=x,y=y), -->
<!--             data=tibble(x=2007:2020,y=32,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid.major.x  = element_blank()) + -->
<!--   scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5), -->
<!--                      labels = c(seq(35,0,-5),seq(5,30,5))) +  -->
<!--   scale_x_continuous(breaks= 2007:2020, labels=2007:2020, -->
<!--                      sec.axis=dup_axis()) + -->
<!--   labs(fill="",x="",  -->
<!--        y=paste0("States reporting ",unique(r_var$name))) -->

<!-- font <- list( -->
<!--   size = 15, -->
<!--   color = "white" -->
<!-- ) -->

<!-- label <- list( -->
<!--   bordercolor = "white", -->
<!--   font = font -->
<!-- ) -->


<!-- ggplotly(plot1, tooltip = 'text') %>%  -->
<!--   style(hoverlabel = label) %>%  -->
<!--   layout(font = font) -->

<!-- ``` -->



<!-- <br> -->

<!-- <br> -->

<!-- ### <em>Smoothed line plots</em> -->

<!-- Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right).  -->

<!-- <br> -->

<!-- ```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")} -->

<!-- # smoothed plots -->
<!-- r_var2 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Order descending -->
<!--  arrange(desc(value)) %>% -->
<!--   # Then put the US last and remove the mean and median -->
<!--   filter(!State %in% c("State average","State median")) %>% -->
<!--   mutate(State = as.character(State)) -->
<!-- r_var2 <- r_var2 %>% -->
<!--   # Apply the order from descending, and put US last -->
<!--   mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US"))) -->


<!-- plot2 <- r_var2 %>%  -->
<!--   ggplot(aes(Year,value, group=State)) +  -->
<!--   geom_smooth(aes(color = "Smoothed"),method=lm, se=F) +  -->
<!--   geom_line(aes(color = "Actual")) + -->
<!--   geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) + -->
<!--   # Add a point for the 2020 state median for the variable -->
<!--   geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"], -->
<!--                  x=2020)) + -->
<!--   facet_wrap(~State, ncol=9) +  -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = c(0.9,0.05), -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->
<!--  # + -->
<!--  #  scale_color_manual(values = c('#e377c2','#2ca02c')) -->



<!-- ggplotly(plot2, tooltip = c('Year',unique(r_var$name)), -->
<!--           ) %>%  -->
<!--   layout(legend = list(x = 0.75, y = 0.05, -->
<!--                        orientation = "h")) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Comparison line plots</em> -->

<!-- Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection.  -->

<!-- Notes: -->

<!-- - It may take a little practice on a touch device to master all the features. -->

<!-- - Line color in Figure 3 is only to make visualization easier. -->

<!-- - Hold down "Shift" to select multiple lines. -->



<!-- <br> -->

<!-- ```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'} -->

<!-- # https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html -->

<!-- # comparison plots -->
<!-- r_var3 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround))  -->

<!-- r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)") -->

<!-- plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State, -->
<!--              height = 750) %>% -->
<!--   group_by(State) %>% -->
<!--   add_trace(text = ~State, hoverinfo = 'text', type = 'scatter', -->
<!--             mode = 'lines+markers', -->
<!--             opacity = 1, marker = list(size = 15, opacity = 1), -->
<!--             line = list(opacity = 1,width = 3.5), -->
<!--               hovertext = -->
<!--               paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>% -->
<!--   layout(showlegend = F, margin = list(l=0,r=120), -->
<!--          xaxis =list(title=""), -->
<!--          yaxis =list(title=unique(r_var$name))) %>%  # y axis label  -->
<!--   plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick', -->
<!--   persistent = T,   # New recommendation to use shift to multiple select -->
<!--   selectize = T, -->
<!--   opacityDim = getOption("opacityDim", 0.1)) %>% -->
<!--   layout(xaxis = list(showgrid = FALSE), -->
<!--           yaxis = list(showgrid = TRUE)) -->
<!-- plot3 -->

<!-- # bscols(widths = c(3, NA), -->
<!-- #        filter_checkbox(id = "id-selector", -->
<!-- #                      label = "Choose state", -->
<!-- #                      sharedData = r_var2_sd, -->
<!-- #                      group = ~State, -->
<!-- #                      columns = 4), -->
<!-- #        p) -->


<!-- ``` -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Boxplots</em> -->


<!-- Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile). -->
<!-- The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics. -->

<!-- ```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'} -->

<!-- # comparison plots -->
<!-- r_var4 <- r_var %>%  -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # Don't want these -->
<!--   filter(!State %in% c("State average","State median","US")) -->

<!-- plot4 <- r_var4 %>%  -->
<!--   ggplot(aes(y=value,group=Year, x=factor(Year),  -->
<!--              color=factor(Year))) + -->
<!--   geom_boxplot() + -->
<!--   theme_minimal() + labs(color="")+ -->
<!--   theme(panel.grid.major.x = element_blank(), -->
<!--         legend.position = "none", -->
<!--         panel.spacing.y = unit(2,'lines'), -->
<!--         panel.spacing.x = unit(1,'lines'), -->
<!--         strip.text.x = element_blank(), -->
<!--         axis.title.x = element_blank(), -->
<!--         strip.text.y = element_text(face='plain')) + -->
<!--   labs(y=unique(r_var$name)) -->

<!-- ggplotly(plot4, tooltip = c("y")) -->

<!-- ``` -->

<!-- <br> -->

<!-- Table shows the numbers by year for the states. -->

<!-- <br> -->

<!-- ```{r, results='asis'} -->

<!-- kable(r_var4 %>% # Data used for box plot -->
<!--         select(Year,value,Code) %>%  # Limit to what we need -->
<!--         arrange(Code) %>%  # 2-letter state abbreviation -->
<!--         pivot_wider(names_from=Year, -->
<!--                     values_from=value), -->
<!--       format='html', digits=3, -->
<!--       caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>%  -->
<!--   kable_styling(full_width = T) -->

<!-- ``` -->

<!-- <br> -->
<!-- <br> -->

<!-- ### <em>Heatmap</em> -->

<!-- In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection. -->


<!-- <br> -->


<!-- ```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")} -->

<!-- # heatmap -->
<!-- r_var5 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) %>% -->
<!--   # It shows the states and US values -->
<!--   filter(!State %in% c("State average","State median")) %>%  -->
<!--   # Make the quartile names descriptive and specific to the variable rounding -->
<!--   mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first -->
<!--                                      Quartile2020 == "1st" ~ -->
<!--                                        paste0("Lowest - ",name,": ", -->
<!--                                               true_round(q0_20,varround)," - ", -->
<!--                                               true_round(q1_20,varround)), -->
<!--                                      Quartile2020 == "2nd" ~ -->
<!--                                        paste0("Moderately low - ",name,": ", -->
<!--                                               true_round(q1_20,varround)," - ", -->
<!--                                               true_round(q2_20,varround)), -->
<!--                                      Quartile2020 == "3rd" ~ -->
<!--                                        paste0("Moderately high - ",name,": ", -->
<!--                                               true_round(q2_20,varround)," - ", -->
<!--                                               true_round(q3_20,varround)), -->
<!--                                      Quartile2020 == "4th" ~ -->
<!--                                        paste0("Highest - ",name,": ", -->
<!--                                               true_round(q3_20,varround)," - ", -->
<!--                                               true_round(q4_20,varround)))) %>% -->
<!--   # Just for this we need to rename Code to State for the display -->
<!--   mutate(State2=State, -->
<!--          State=Code) -->

<!-- # Order it for display -->
<!-- r_var5 %<>% mutate(Quartile2020lab =  -->
<!--                      factor(Quartile2020lab, -->
<!--                             # US, high to low -->
<!--                             sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab)) -->

<!-- r_var5_sd <- SharedData$new(r_var5, ~State) -->

<!-- # Plot -->
<!-- plot5 <- r_var5_sd %>%  -->
<!--   ggplot(aes(x=Year,y=Rank2Plot, -->
<!--              label=State,group=State,fill=Quartile2020lab, -->
<!--              text = paste0(name,": ",value))) +  -->
<!--   geom_tile(color='white') + -->
<!--   geom_text(size=4, fontface='bold',color='black') + -->
<!--     geom_text(aes(label =label,x=x,y=y),  -->
<!--               data=tibble(x=2007:2020,y=53,label=2007:2020), -->
<!--             inherit.aes = F,size=3.25,fontface='plain') + -->
<!--   theme_minimal() + theme(panel.grid = element_blank(), -->
<!--                           axis.text.y = element_blank()) + -->
<!--   scale_x_continuous(breaks = 2007:2020) +  -->
<!--   labs(fill="",x="",y="")  -->



<!-- ggplotly(plot5, -->
<!--          tooltip = c("label","x", "text" )) %>%  -->
<!--   highlight(on = "plotly_click", off = "plotly_doubleclick", -->
<!--              persistent=T) -->

<!-- ``` -->

<!-- Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable. -->

<!-- <br> -->
<!-- <br> -->


<!-- ### <em>Annual map comparison</em> -->

<!-- - Hover over a state to see more information.  -->

<!-- - Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states.  -->

<!-- - Color scale stays constant to range across values from 2007-2020.  -->

<!-- ```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")} -->

<!-- r_var6 <- r_var %>% -->
<!--   mutate(value = true_round(value,varround)) -->

<!-- plot6 <-  -->
<!--   # Set up plot_geo for mapping with plotly -->
<!--   plot_geo( -->
<!--     # Identify the data -->
<!--     r_var6, -->
<!--     # Set the location to states -->
<!--     locationmode = 'USA-states', -->
<!--     # Set up for slider (to call a column in plotly, use ~) -->
<!--     frame = ~Year) %>% -->

<!--   # Add a trace layer onto graph -- the data -->
<!--   add_trace( -->
<!--     # Specify the states -->
<!--     locations = ~Code,  # what column in data has the state abbr -->
<!--     # Color the states -->
<!--     z = ~value,  # what column in data has the data that we want to fill by -->
<!--     # If we want a constant scale for the coloring over the years, set min max -->
<!--     zmin = min(r_var6$value, na.rm=T), -->
<!--     zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max -->
<!--     # To use specific colors, -->
<!--     color = ~value,  # what variable has the data to color by -->
<!--     # colors = "Purples",  # what color palette to use -->
<!--     reversescale=T,  # because scale was showing darker for lower -->
<!--     marker = list(line=list(width=1,  # Use a color to border polygon that shows -->
<!--                             color='DarkSlateGrey')), -->
<!--     colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend -->
<!--     hoverinfo = 'text',  -->
<!--     hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ", -->
<!--                     r_var6$value) -->
<!--   ) %>% -->

<!--   # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics  -->
<!--   layout( -->
<!--     # Change the view to be specific to the US -->
<!--     geo = list(scope = 'usa'), -->
<!--     # Choose what font is to be used -->
<!--     font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system -->
<!--   ) %>% -->
<!-- # if you want the toolbar removed -->
<!-- config(displayModeBar = FALSE -->
<!--        ) -->
<!-- # # if you need to adjust display of the scale bar -->
<!-- # colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values -->
<!--    # colorbar(title = "Justices")  -->

<!-- plot6 -->

<!-- ``` -->



## <strong>`r unique(vardesc$Variable)[54]`</strong>

```{r}

# Set this up at the start of the chunks for a variable!

# Dataframe to be used
r_var <- r1 %>%
  # Filter to the variable of interest for use
  filter(name %in% vardesc$`Variable Abbreviation`[54])

# Rounding specific to the variable
varround <- vardesc$Rounding[54]

```

<br>

This section takes a look at <strong>`r unique(r_var$name)`, `r unique(r_var$Definition)`</strong>. It was calculated using the formula `r unique(r_var$Formula)`. `r unique(r_var$"Decision Maker Takeaway")`.

<br>

### <em>States above and below 2020 median `r unique(r_var$name)` value by year, 2007-2020</em>

Figure displays the numbers of states above and below the 2020 median `r unique(r_var$name)` value. Mouse over the bars to see the percentage of states reporting above or below the 2020 median each year.

```{r, fig.cap= paste0("States above and below 2020 median ",unique(r_var$name)," value",unique(r_var$median_2020)," by year, 2007-2020")}

# Then utilize as needed with formatting
r_var1 <- r_var %>%
  # Edit for display
  mutate(medianCat = factor(
    ifelse(medianCat == "Below", 
           paste0("Below 2020 median ",name," (",true_round(median2020,varround),")"),
           paste0("Above 2020 median ",name," (",true_round(median2020,varround),")")
    ))) %>%
  select(Year,name,pc,medianCat,medianCatCount,medianCatCountPlot) %>%
  distinct() %>%
  na.omit()


plot1 <- r_var1 %>% 
  ggplot(aes(x=Year, y=medianCatCountPlot, fill=medianCat,
             text = paste0(Year,"\nStates: ",`medianCatCount`,
                           " (",pc,"%)"))) +
  geom_col() + 
  geom_hline(yintercept=0,  color = 'white') + 
  geom_text(aes(label =label,x=x,y=y),
            data=tibble(x=2007:2020,y=32,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid.major.x  = element_blank()) +
  scale_y_continuous(limits=c(-40,32),breaks = seq(-35,30,5),
                     labels = c(seq(35,0,-5),seq(5,30,5))) + 
  scale_x_continuous(breaks= 2007:2020, labels=2007:2020,
                     sec.axis=dup_axis()) +
  labs(fill="",x="", 
       y=paste0("States reporting ",unique(r_var$name)))

font <- list(
  size = 15,
  color = "white"
)

label <- list(
  bordercolor = "white",
  font = font
)


ggplotly(plot1, tooltip = 'text') %>% 
  style(hoverlabel = label) %>% 
  layout(font = font)

```



<br>

<br>

### <em>Smoothed line plots</em>

Figure 2 shows the `r unique(r_var$name)` value by state (pink lines) and smoothed trend lines (green) to discard small year-to-year variations. States are ordered from top to bottom by their latest `r unique(r_var$name)` values. The black dots represent the state median in 2020 for comparison. Remove either type of line from all states in the figure by clicking on the legend (bottom right). 

<br>

```{r, fig.cap=paste0("Smoothed line plots: ",unique(r_var$name)," by state, 2007-2020")}

# smoothed plots
r_var2 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Order descending
  arrange(desc(value)) %>%
  # Then put the US last and remove the mean and median
  filter(!State %in% c("State average","State median")) %>%
  mutate(State = as.character(State))
r_var2 <- r_var2 %>%
  # Apply the order from descending, and put US last
  mutate(State = factor(State, c(unique(r_var2$State[r_var2$State!="US"]),"US")))


plot2 <- r_var2 %>% 
  ggplot(aes(Year,value, group=State)) + 
  geom_smooth(aes(color = "Smoothed"),method=lm, se=F) + 
  geom_line(aes(color = "Actual")) +
  geom_text(aes(x = 2013, y = 4,label=State), inherit.aes = F) +
  # Add a point for the 2020 state median for the variable
  geom_point(aes(y=r_var$value[r_var$State=="State median"&r_var$Year=="2020"],
                 x=2020)) +
  facet_wrap(~State, ncol=9) + 
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = c(0.9,0.05),
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))
# +
#  scale_color_manual(values = c('#e377c2','#2ca02c'))



ggplotly(plot2, tooltip = c('Year',unique(r_var$name)),
) %>% 
  layout(legend = list(x = 0.75, y = 0.05,
                       orientation = "h"))


```

<br>
<br>

### <em>Comparison line plots</em>

Figure shows the `r unique(r_var$name)` by state and for the US overall along with annual state average and median. Hover over a point to get state, year, `r unique(r_var$name)` value, and quartile (Highest, Moderately High, Moderately Low, Lowest). Click on a line or point to isolate it, or choose one or more lines to compare from the dropdown menu. Double-click in the whitespace to bring all the lines back. To zoom in after selecting states for comparison, drag and drop the mouse from left to right over the plot area. If applicable, the range of the axes will change to fit the selection. 

Notes:

- It may take a little practice on a touch device to master all the features.

- Line color in Figure 3 is only to make visualization easier.

- Hold down "Shift" to select multiple lines.



<br>

```{r, fig.cap=paste0(unique(r_var$name)," by state and in the aggregate, 2007-2020"), fig.align='left'}

# https://rstudio-pubs-static.s3.amazonaws.com/352801_12ebacbc1acb46ff89dd0a08cc1301f3.html

# comparison plots
r_var3 <- r_var %>% 
  mutate(value = true_round(value,varround)) 

r_var3_sd <- SharedData$new(r_var3, ~State, group = "Choose state(s)")

plot3 <- plot_ly(r_var3_sd, x = ~Year, y = ~value, color= ~State,
                 height = 750) %>%
  group_by(State) %>%
  add_trace(text = ~State, hoverinfo = 'text', type = 'scatter',
            mode = 'lines+markers',
            opacity = 1, marker = list(size = 15, opacity = 1),
            line = list(opacity = 1,width = 3.5),
            hovertext =
              paste0(r_var3$Code," ",r_var3$Year,"<br>",unique(r_var$name),": ",r_var3$value,"<br>Q: ",r_var3$Quartile)) %>%
  layout(showlegend = F, margin = list(l=0,r=120),
         xaxis =list(title=""),
         yaxis =list(title=unique(r_var$name))) %>%  # y axis label 
  plotly::highlight(on = "plotly_click", off = 'plotly_doubleclick',
                    persistent = T,   # New recommendation to use shift to multiple select
                    selectize = T,
                    opacityDim = getOption("opacityDim", 0.1)) %>%
  layout(xaxis = list(showgrid = FALSE),
         yaxis = list(showgrid = TRUE))
plot3

# bscols(widths = c(3, NA),
#        filter_checkbox(id = "id-selector",
#                      label = "Choose state",
#                      sharedData = r_var2_sd,
#                      group = ~State,
#                      columns = 4),
#        p)


```

<br>
<br>


### <em>Boxplots</em>


Figure shows the distributions of states' `r unique(r_var$name)` values in boxplots by year. The area in the box begins with the first quartile (25th percentile). The middle line represents the median data point, and the top of the box is the third quartile (75th percentile).
The <i>whiskers</i> (lines beyond the box) show the minimum value on the bottom,or the <i>lower fence</i> when outliers are present. The <i>upper fence</i> is at the top of the line. The fence values represent where the minimum and maximum values would be if the distribution were normal. Dots above and below the whiskers represent outliers. Mouse over the boxes and whiskers to view all these statistics.

```{r fig.cap=paste0("State ",unique(r_var$name)," distribution by year, 2007-2020"), fig.align='left'}

# comparison plots
r_var4 <- r_var %>% 
  mutate(value = true_round(value,varround)) %>%
  # Don't want these
  filter(!State %in% c("State average","State median","US"))

plot4 <- r_var4 %>% 
  ggplot(aes(y=value,group=Year, x=factor(Year), 
             color=factor(Year))) +
  geom_boxplot() +
  theme_minimal() + labs(color="")+
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none",
        panel.spacing.y = unit(2,'lines'),
        panel.spacing.x = unit(1,'lines'),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.y = element_text(face='plain')) +
  labs(y=unique(r_var$name))

ggplotly(plot4, tooltip = c("y"))

```

<br>

Table shows the numbers by year for the states.

<br>

```{r, results='asis'}

kable(r_var4 %>% # Data used for box plot
        select(Year,value,Code) %>%  # Limit to what we need
        arrange(Code) %>%  # 2-letter state abbreviation
        pivot_wider(names_from=Year,
                    values_from=value),
      format='html', digits=3,
      caption = paste0("States' ",unique(r_var$name)," values by year, 2007-2020")) %>% 
  kable_styling(full_width = T)

```

<br>
<br>

### <em>Heatmap</em>

In the figure, states are ranked and color coded in 4 fixed `r unique(r_var$name)` ranges. These ranges are determined by 2020 quartiles.  In this way, it is possible to see how the distribution of states (in the fixed intervals defined in the key) has changed over time. States are ordered from highest (top) to lowest (bottom) average `r unique(r_var$name)` (top to bottom). Mouse over any box for more information. Click on a state or states to isolate all years for the selection.


<br>


```{r fig.cap=paste0("Heatmap: ",unique(r_var$name)," by state (Quartiles), 2007-2020")}

# heatmap
r_var5 <- r_var %>%
  mutate(value = true_round(value,varround)) %>%
  # It shows the states and US values
  filter(!State %in% c("State average","State median")) %>% 
  # Make the quartile names descriptive and specific to the variable rounding
  mutate(Quartile2020lab = case_when(State == "US" ~ "US",  # Need to put these values first
                                     Quartile2020 == "1st" ~
                                       paste0("Lowest - ",name,": ",
                                              true_round(q0_20,varround)," - ",
                                              true_round(q1_20,varround)),
                                     Quartile2020 == "2nd" ~
                                       paste0("Moderately low - ",name,": ",
                                              true_round(q1_20,varround)," - ",
                                              true_round(q2_20,varround)),
                                     Quartile2020 == "3rd" ~
                                       paste0("Moderately high - ",name,": ",
                                              true_round(q2_20,varround)," - ",
                                              true_round(q3_20,varround)),
                                     Quartile2020 == "4th" ~
                                       paste0("Highest - ",name,": ",
                                              true_round(q3_20,varround)," - ",
                                              true_round(q4_20,varround)))) %>%
  # Just for this we need to rename Code to State for the display
  mutate(State2=State,
         State=Code)

# Order it for display
r_var5 %<>% mutate(Quartile2020lab = 
                     factor(Quartile2020lab,
                            # US, high to low
                            sort(unique(r_var5$Quartile2020lab))[c(5,1,3,4,2)]))  %>%
  # Drop the NA group that shows up
  filter(!is.na(Quartile2020lab))

r_var5_sd <- SharedData$new(r_var5, ~State)

# Plot
plot5 <- r_var5_sd %>% 
  ggplot(aes(x=Year,y=Rank2Plot,
             label=State,group=State,fill=Quartile2020lab,
             text = paste0(name,": ",value))) + 
  geom_tile(color='white') +
  geom_text(size=4, fontface='bold',color='black') +
  geom_text(aes(label =label,x=x,y=y), 
            data=tibble(x=2007:2020,y=53,label=2007:2020),
            inherit.aes = F,size=3.25,fontface='plain') +
  theme_minimal() + theme(panel.grid = element_blank(),
                          axis.text.y = element_blank()) +
  scale_x_continuous(breaks = 2007:2020) + 
  labs(fill="",x="",y="") 



ggplotly(plot5,
         tooltip = c("label","x", "text" )) %>% 
  highlight(on = "plotly_click", off = "plotly_doubleclick",
            persistent=T)

```

Data not available for or within every state in 2007-2020. See Data Availability Table for years of missing data for each state/variable.

<br>
<br>


### <em>Annual map comparison</em>

- Hover over a state to see more information. 

- Slide to a different year at the bottom of the map to see how `r `unique(r_var$name)` values change over time across states. 

- Color scale stays constant to range across values from 2007-2020. 

```{r fig.cap=paste0("Annual state map: ",unique(r_var$name),", 2007-2020")}

r_var6 <- r_var %>%
  mutate(value = true_round(value,varround))

plot6 <- 
  # Set up plot_geo for mapping with plotly
  plot_geo(
    # Identify the data
    r_var6,
    # Set the location to states
    locationmode = 'USA-states',
    # Set up for slider (to call a column in plotly, use ~)
    frame = ~Year) %>%
  
  # Add a trace layer onto graph -- the data
  add_trace(
    # Specify the states
    locations = ~Code,  # what column in data has the state abbr
    # Color the states
    z = ~value,  # what column in data has the data that we want to fill by
    # If we want a constant scale for the coloring over the years, set min max
    zmin = min(r_var6$value, na.rm=T),
    zmax = max(r_var6$value, na.rm=T),  # What variable has the z data, code for the max
    # To use specific colors,
    color = ~value,  # what variable has the data to color by
    # colors = "Purples",  # what color palette to use
    reversescale=T,  # because scale was showing darker for lower
    marker = list(line=list(width=1,  # Use a color to border polygon that shows
                            color='DarkSlateGrey')),
    colorbar = list(title = unique(r_var$name)),  ## Adjust title for legend
    hoverinfo = 'text', 
    hovertext = paste0(r_var6$Code," ",r_var6$Year,"<br>",unique(r_var$name),": ",
                       r_var6$value)
  ) %>%
  
  # Add another layer (specifically layout) to the plotly that allows us to adjust the aesthetics 
  layout(
    # Change the view to be specific to the US
    geo = list(scope = 'usa'),
    # Choose what font is to be used
    font = list(family = "Bookman Old Style")  # extrafont::fonts() to see all fonts on system
  ) %>%
  # if you want the toolbar removed
  config(displayModeBar = FALSE
  )
# # if you need to adjust display of the scale bar
# colorbar(tickprefix = "$")  # if you wanted to add a dollar sign before values
# colorbar(title = "Justices") 

plot6

```
